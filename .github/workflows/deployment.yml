name: Build And Publish to Amazon ECR

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  ci:
    uses: vti-do2402/cicd-core/.github/workflows/maven-spring-ci.yml@dev
    with:
      runs-on: ${{ vars.RUNS_ON }}
      java-version: ${{ vars.JAVA_VERSION }}
      distribution: ${{ vars.JAVA_DISTRIBUTION }}

  approval:
    needs: ci
    runs-on: ${{ vars.RUNS_ON }}
    environment: production
    timeout-minutes: 3
    steps:
      - name: Approve
        run: echo "Approved"

  deploy:
    needs: approval
    uses: vti-do2402/cicd-core/.github/workflows/deploy-ecr-template.yml@dev
    with:
      environment: ${{ vars.ENVIRONMENT }}
      runs-on: ${{ vars.RUNS_ON }}
      ecr-repository: ${{ vars.ECR_REPOSITORY }}
      default_bump: ${{ vars.VERSION_BUMP_TYPE }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
